<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="ko">
<!--
	Future Imperfect by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<head>
    <meta charset="UTF-8">
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/requestpost.css}" rel="stylesheet">
    <title>NOWNESS_detail</title>
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <meta name="_csrf" th:content="${_csrf.token}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

    <style>
        .col-sm-12.sub.deletereplybtn {
            width: 48.46px;
            height: 38.48px;
            display: inline;
        }

        .col-sm-12 sub{
            display: inline-block;
            clear:both;
            float:left;
        }


        button.deletereplybtn {

            border-color: transparent;
            background-color: transparent;
        }

        a {
            text-decoration: none;
            color : black;
        }

    </style>

    <script th:inline="javascript">
        $(document).ready(function() {
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");
            var boardId = /*[[${postdetail.id}]]*/;

            /*<![CDATA[*/
            var loginuser = [[${userId}]];
            var postwriter = [[${postdetail.userId}]];
            /*]]>*/


            // í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ“ê¸€ ê°€ì ¸ì˜¤ê¸°
            getReplyList(boardId);

            //ëŒ“ê¸€ textarea ì—”í„°ì²˜ë¦¬ìš©.
            //enter => <br>
            var text = $('textarea').val();
            text = text.replace(/(?:\r\n|\r|\n)/g, '<br>');

            //<br> => enter
            var text = $('textarea').val();
            text = text.split('<br>').join("\r\n");


            // ëŒ“ê¸€ ë“±ë¡  : ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬(ë¡œê·¸ì¸ìœ ì €ê°€ ë§ëŠ”ì§€ í™•ì¸)
            $("#submitbtn").click(function(event) {
                event.preventDefault();
                var replyContents = $("#contents").val();
                var verifiedUser = [[${verifiedUser}]];

                //ë¡œê·¸ì¸ì—¬ë¶€ & ì´ë©”ì¼ì¸ì¦ í™•ì¸ë°›ìŒ & ë¹ˆì¹¸ì´ì•„ë‹ˆì–´ì•¼ ë“±ë¡ê°€ëŠ¥.
                if(loginuser!=null ){//ë¡œê·¸ì¸O

                    if(verifiedUser ==true){//ë¡œê·¸ì¸O, ì´ë©”ì¼ê²€ì¦O

                        if (replyContents.trim() === "") {//ë¹ˆì¹¸ì¸ê²½ìš°
                            alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
                            return;
                        }else {//ë¡œê·¸ì¸O, ì´ë©”ì¼ê²€ì¦O, ë‚´ìš©ì´ì…ë ¥ëœê²½ìš°
                            $.ajax({
                                url: "/request/writeReply",
                                data: {
                                    "userid": /*[[${userId}]]*/,
                                    "contentsid": boardId,
                                    "reply": replyContents
                                },
                                beforeSend: function (xhr) {
                                    xhr.setRequestHeader(header, token);
                                },
                                type: "post",
                                success: function (result) {
                                    if (result === "success") {
                                        // ëŒ“ê¸€ ì…ë ¥ì¹¸ ë¹„ìš°ê¸°
                                        $("#contents").val("");
                                        // ìƒˆë¡œìš´ ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
                                        getReplyList(boardId);
                                    } else {
                                        alert("ERROR-1.");
                                    }
                                },
                                error: function () {
                                    alert("ERROR-2");
                                }
                            });//ajax end-ëŒ“ê¸€ë“±ë¡ end
                        }//ë¡œê·¸ì¸Oì´ë©”ì¼ê²€ì¦O-end
                    }
                    else{//ë¡œê·¸ì¸oì´ë©”ì¼ê²€ì¦X
                        alert("ì´ë©”ì¼ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
                    }//ë¡œê·¸ì¸ê³¼ ì´ë©”ì¼ê²€ì¦ì—¬ë¶€-end
                }else{
                    //ë¡œê·¸ì¸Xì¸ê²½ìš°
                    alert("ë¡œê·¸ì¸ì„ í•˜ì…”ì•¼ ëŒ“ê¸€ì„ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                }//ë¡œê·¸ì¸ì—¬ë¶€ end
            });//ëŒ“ê¸€ë“±ë¡end




            //ê¸€ ì‚­ì œ :  ë³¸ì¸ì´ë§ìœ¼ë©´ ë²„íŠ¼ì´ ë³´ì´ê³ , í´ë¦­ì‹œ ì‚­ì œì—¬ë¶€ ë¬¼ìŒ
            $(document).on("click", "#postdeletebtn", function(event) {
                event.preventDefault();

                if (loginuser == postwriter) {
                    if (confirm("ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        window.location.href = $(this).attr("href");
                    }
                } else {
                    alert("ì‘ì„±ì ë³¸ì¸ë§Œ ì‚­ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                }
            });




            //ëŒ“ê¸€ ì‚­ì œ : ì‘ì„±ìì™€ ë¡œê·¸ì¸ ìœ ì €ê°€ ë§ëŠ”ì§€ í™•ì¸ , ì‚­ì œì—¬ë¶€ í™•ì¸ í›„ ì‚­ì œ.
            $(document).on("click", ".deletereplybtn", function(event) {
                event.preventDefault();

                var replyId = $(this).data("replyid");
                var replyWriterId = $(this).data("replyuserid");


                if(loginuser == replyWriterId){
                    if (confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        deleteReply(replyId);
                    }
                 }else{
                    alert("ìì‹ ì´ ì‘ì„±í•œ ëŒ“ê¸€ë§Œ ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                }
            });
        });


        // ëŒ“ê¸€ ì‚­ì œ AJAX ìš”ì²­
        function deleteReply(replyId) {
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            $.ajax({
                url: "/request/deleteReply",
                data: {
                    "replyId": replyId
                },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                type: "post",
                success: function(result) {
                    if (result === "success") {
                        var boardId = /*[[${postdetail.id}]]*/;
                        getReplyList(boardId);
                    } else {
                    }
                },
                error: function() {
                }
            });
        }

    //ëŒ“ê¸€ ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
        function getNicknameForComment(id) {
            var nickname = '';

            $.ajax({
                url: "/request/getNickname/" + id,
                async: false,
                success: function(result) {
                    nickname = result;
                },
                error: function() {
                    console.error("Error occurred while fetching nickname for id: " + id);
                }
            });

            return nickname;
        }



        // ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        function getReplyList(boardId) {
            $.ajax({
                url: "/request/getComments",
                data: {
                    "contentsid": boardId
                },
                type: "get",
                success: function(result) {
                    // ëŒ“ê¸€ ë³´ì—¬ì£¼ê¸°
                    drawReply(result);
                },
                error: function() {
                }
            });
        }


        // ëŒ“ê¸€ ë³´ì—¬ì£¼ëŠ” ê¸°ëŠ¥
        function drawReply(replys) {
            var html = '';

            replys.forEach(function(reply) {
                if (reply.parentid == 0) {
                    var nickname = getNicknameForComment(reply.id);
                    html += '<div class="row"><div class="col-sm-12">';
                    html += '<form class="form-inline" action="/writeReply" method="post">';
                    html += '<label for="pwd" class="mr-sm-2">' + "[ì‘ì„±ì : " +nickname +  " ] " +'</label>';
                    html += '<label for="pwd" class="mr-sm-2">' + "( " + reply.createddatetime + ")"+ '</label>';
                    // html += '<button type="button" class="btn btn-primary mb-2 deletereplybtn" data-replyid="' + reply.id + '">âŒ</button>';
                    html += '<button type="button" class="btn btn-primary mb-2 deletereplybtn" data-replyid="' + reply.id + '" data-replyuserid="' + reply.userid + '">âŒ</button>';
                    html += '<br>';
                    // html += '<label for="pwd" class="mr-sm-2">'  +  reply.reply + '</label>';
                    html += '<label for="pwd" class="mr-sm-2">'  +  reply.reply.replace(/\n/g, '<br>') + '</label>';
                   html += '<input type="hidden" name="id" th:value="${postdetail.id}">';
                    html += '<input type="hidden" name="parentid" th:value="' + reply.id + '">';
                    html += '</form>';
                    html += '<hr>';
                    html += '<div class="row"><div class="col-sm-12 sub' + reply.id + '"></div></div></div></div>';
                }
            });

            $("#replyArea").html(html);

            replys.forEach(function(reply) {
                if (reply.parentid != 0) {
                    var nickname = getNicknameForComment(reply.id);
                    var subHtml = '';
                    subHtml = '<div class="row"><div class="col-sm-12 subReply">';
                    //ì•ˆì”€ subHtml += 'ã„´ <label for="pwd" class="col-sm-12 sub">'+ "[ì‘ì„±ì : " + nickname + " ] "  + reply.reply + "( " + reply.createddatetime + ")"+  '</label>';
                    //ì•ˆì”€ subHtml += 'ã„´ <label for="pwd" class="col-sm-12 sub">'+ "[ì‘ì„±ì : " + nickname + " ] "  + reply.reply.replace(/\n/g, '<br>') + "( " + reply.createddatetime + ")"+  '</label>';
                    subHtml += '<label for="pwd" class="mr-sm-2 sub">'+ "ã„´[ì‘ì„±ì : " + nickname + " ] " + "( " + reply.createddatetime + ")"+  '</label>';
                    //ì•ˆì”€ subHtml += '<button type="button" class="col-sm-12 sub deletereplybtn" data-replyid="' + reply.id + '">âŒ</button>';
                    subHtml += '<button type="button" class="mr-sm-2 sub deletereplybtn" data-replyid="' + reply.id + '" data-replyuserid="' + reply.userid + '">âŒ</button>';
                    subHtml += '<label for="pwd" class="col-sm-12 sub">'+ reply.reply.replace(/\n/g, '<br>') +  '</label>';
                    subHtml += '<hr>';
                    subHtml += '<div class="row"><div class="col-sm-12 sub' + reply.id + '"></div></div></div></div>';

                    $(".sub" + reply.parentid).append(subHtml);
                }
            });
        }
    </script>

</head>




<body>
<!--í—¤ë”-->
<div th:insert="~{header :: header}"></div>

<!--ë°”ë””-ë³¸ë¬¸-->

<!--ê²Œì‹œê¸€ ì„¸ë¶€ë‚´ìš© ë³¸ë¬¸-->
<div class="container">
    <a class="btn btn-light" id="backbtn" href="javascript:history.back()">back</a>

    <!--ê²Œì‹œê¸€ ìƒì„¸ë‚´ìš©-->
    <div id="main">
        <article class="post">
            <!-- ê²Œì‹œê¸€ ë‚´ë¶€ ìƒë‹¨ header : ì§„ì§œ í—¤ë”ë‘ ê²¹ì¹ ê±°ê°™ìŒ..??-->
            <header>
                <div class="title">
                    <h2 th:text="${postdetail.title}"></h2>
                </div>

                <!--ì˜¤ë¥¸ìª½ë¶€ë¶„ ë‚ ì§œì™€ ë‹‰ë„¤ì„-->
                <div class="meta">
                    <time class="published" th:text="${#temporals.format(postdetail.createdDatetime,'yyyy-MM-dd HH:mm:ss')}"></time>
                    <a href="#" class="author"><span class="name" th:text="${nickname}"></span><img src="images/avatar.jpg" alt="" /></a>
                </div>
            </header>

            <!-- ê¸€ ë³¸ë¬¸ ìë¦¬-->
            <p th:utext="${postdetail.contents}"></p>







            <!-- ë¡œê·¸ì¸ ìœ ì € í™•ì¸ í›„, ê²Œì‹œê¸€ ì‘ì„±ìì™€ ì¼ì¹˜í•˜ë©´ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ìƒì„±-->
            <footer>
                <ul class="stats">
                    <li><a href="#" class="icon solid fa-viewt">view <span th:text="${postdetail.views}"></span></a></li>
<!--                    <li><a href="#" class="icon solid fa-heart"><span th:text="${likes}"></span></a></li>-->
<!--                    <li><a href="#" class="icon solid fa-heart"><span th:text="${likes}"></span></a></li>-->
                    <li><a href="#" >ğŸ’–<span th:text="${likes}"></span></a></li>
                    <li><a href="#" class="icon solid fa-comment">comment <span th:text="${comments.size()}"></span></a></li>
                    <li><a href="#" class="icon solid fa-report">report</a></li>
                <th:block th:if="${userId == postdetail.userId }">
<!--                    <li><a href="#" class="icon solid fa-modify">modify</a></li>-->
                    <li><a th:href="@{/request/modify/{id}(id = ${postdetail.id})}" class="icon solid fa-modify">modify</a></li>
                    <li><a th:href="@{'/request/post/' + ${id} + '/delete'}" class="icon solid fa-delete" id="postdeletebtn">delete</a></li>
                </th:block>

                </ul>

                <ul class="hash">
                    <li></li>
                </ul>

            </footer>
        </article>
    </div> <!--ê²Œì‹œê¸€ë‚´ìš© div end-->


    <!--ëŒ“ê¸€ë“±ë¡-->
    <form id="commentForm" class="form-inline" th:action="@{/request/writeReply}" method="post">
<!--        <input type="hidden" name="userid"  th:value="${user.id}">-->
        <input type="hidden" name="userid"  th:value="${userId}">
        <input type="hidden" name="contentsid" th:value="${postdetail.id}">
<!--        <input type="text" class="form-control mb-2 mr-sm-2" id="contents" placeholder="ë¡œê·¸ì¸ì„ í•´ì•¼ ëŒ“ê¸€ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." name="reply" required>-->
        <textarea class="form-control mb-2 mr-sm-2" id="contents" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.(ì¸ì¦ëœ ë¡œê·¸ì¸ ìœ ì €ë§Œ ì‚¬ìš©ê°€ëŠ¥í•©ë‹ˆë‹¤.)" name="reply" required></textarea>
        <button type="button" class="btn btn-outline-dark" id="submitbtn">ë“±ë¡</button>
    </form>


    <!--ëŒ“ê¸€ ë³´ì—¬ì£¼ëŠ” ê³³ -->
    <div class="comments">
        <h2 id="cnt"></h2>
        <div id="replyArea"></div>
    </div>


<!--ë¡œê·¸ì¸ìœ ì €-->


<!--            <span th:text="${postdetail}"></span>-->
<!--        <br>-->
<!--        <span th:text="${user.id}"></span>-->
<!--    <hr>-->
<!--    <span th:text="${userId}"></span>-->

<!--    ì´ë©”ì¼ì¸ì¦-->
<!--    <span th:text="${verifiedUser}"></span> -->


    <div th:insert="~{footer :: footer}"></div>
    <script th:src="@{/static/js/bootstrap.min.js}"></script>
</div>
</body>
</html>
